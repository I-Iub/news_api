# news_api

Ссылки на запущенное приложение:
- [панель администратора](http://45.145.65.42/admin/)
- [документация API](http://45.145.65.42/swagger/)

В файле `news_api.postman_collection.json` коллекция для импорта в Postman.

---
## Оглавление
- [Запуск проекта](#start_project)
- [Запуск сервера разработчика и тестов](#startserver)
- [Особенности](#features)

---
<a id=start_project></a>
## Запуск проекта

Клонируйте проект в целевую папку.
```
git clone https://github.com/I-Iub/news_api.git
```

Перейдите в папку с проектом. Создайте файл `.env`. Запишите в файл `.env` 
переменные по примеру в файле [.env.example](https://github.com/I-Iub/news_api/blob/main/.env.example).

Если проект разворачивается на удалённом сервере, а не локально, то в файле 
`news/news/settings.py` в переменных `CSRF_TRUSTED_ORIGINS` и `ALLOWED_HOSTS` 
укажите доменное имя или IP хоста.
```
ALLOWED_HOSTS = ['<домен или IP>']
CSRF_TRUSTED_ORIGINS = ['http://<домен или IP>']
```

Запустите контейнеры:
```
docker compose up -d
docker compose exec web python manage.py migrate               # миграции
docker compose exec web python manage.py collectstatic         # собрать статику
docker compose exec web python manage.py createsuperuser       # создать суперпользователя
```
Готово.

---
<a id=startserver></a>
## Запуск сервера разработчика и тестов

Создайте виртуальное окружение и активируйте его (работа проверялась только на 
Python 3.10.5).
```
python3 -m venv venv
. venv/bin/activate     # Linux
```

Установите зависимости
```
pip install --upgrade pip
pip install -r requirements.txt
```

В приведённой выше инструкции "Запуск проекта" по команде `docker compose up -d` 
контейнер базы данных запускается без открытых наружу портов. Тестам и серверу 
разработчика нужен доступ к базе, поэтому для их запуска нужно открыть порты. 
Тесты не изменяют имеющиеся данные в базе данных и не добавляют в неё новые записи. 
Остановите контейнеры. Находясь в корневой папке проекта выполните:
```
docker compose down
```
И запустите контейнеры, указав файл `docker-compose.dev.yaml`:
```
docker compose -f docker-compose.dev.yaml up -d
```
Запустите тесты:
```
pytest
```
Для запуска сервера разработчика перейдите в папку news (в ней есть файл 
manage.py)
```
cd news
POSTGRES_HOST=localhost POSTGRES_PORT=35432 python manage.py runserver
```

---
<a id=features></a>
## Особенности

#### Эффективный запрос для получения новостей и комментариев к ним

Для получения не более десяти комментариев к каждой новости при получении 
списка новостей используется 
[SQL-запрос](https://github.com/I-Iub/news_api/blob/main/news/api/utils.py#L7).  
При этом есть пагинация за счёт пользовательского 
[класса пагинатора](https://github.com/I-Iub/news_api/blob/main/news/api/pagination.py#L10). 
Запрос устроен следующим образом: 
- с помощью обобщённого табличного выражения (WITH) получается список новостей. 
Этот подзапрос включает операторы `limit` и `offset` для пагинации;
- к списку новостей делается `left join` подзапроса получения комментариев;
- подзапрос получения комментариев также содержит оператор `limit 10`, за счёт 
этого из базы данных извлекается не больше десяти комментариев на каждую новость;
- подзапрос получения комментариев содержит оконную функцию, позволяющую 
получить количество комментариев, написанных под связанной новостью.

Преимущества такого запроса:
- выполняется только один запрос к базе данных для получения всех необходимых 
записей;
- значительно экономится оперативная память по сравнению с простым `join`, например, 
который получает все связанные комментарии для каждой новости. Допустим, 
мы хотим получить десять новостей и для каждой из них в базе данных сохранено 
1000 комментариев, тогда обычный `join` загрузит в базу данных 10 * 1000 строк 
результата. А представленный в коде -- 10 * 10. Разница будет ещё серьёзнее, 
если комментариев у каждой новости будет гораздо больше.

В Django нет возможности написать эквивалентный запрос средствами Django ORM 
(по крайней мере до версии 4.1 включительно). 
